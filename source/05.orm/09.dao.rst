.. _orm-pattern:

Estrategias de diseño
=====================
Cuando analizamos :ref:`conectores <conn>`, ya expusimos que uno de los patrones
de diseño más socorridos es el patrón |DAO|. Al usar un |ORM| podríamos seguir
esa misma estrategia y definir una interfaz |CRUD| para crear clases |DAO| para
todas las entidades del modelo. En este caso, la única salvedad es que las
implementaciones de los métodos de la interfaz no se basarían en |JDBC| sino en
|JPA|. Ahora bien, muy comúnmente y a menos que nuestra intención sea
reaprovechar una interfaz antigua implementada con |JDBC|, obrar de esta manera
es un poco redundante, ya que el propio |JPA| tiene una orientación semejante a
|DAO|.

Lo que sí es muy conveniente es intentar liberar al resto del código de las
particularidades del acceso, así que conviene encerrarlas en una clase auxiliar.
Podríamos proponer esta:

.. literalinclude:: files/JpaBackend.java
   :class: toggle
   :caption: JpaBackend.java
   :language: java
   :start-at: /**

Esta clase crea fábricas de gestores de entidades asociadas a claves, pero las
oculta y sólo permite utilizar los gestores de entidades a través de
transacciones.

.. code-block:: java

   // Propiedades configuradas en tiempo de ejecución.
   Map<String, String> props = new HashMap<>();
   props.put("jakarta.persistence.jdbc.url", "jdbc:sqlite:centro.db");
   props.put("hibernate.show_sql", "true");

   // Configuración en persistence.xml + propiedades dinámicas
   try(JpaBackend jb = JpaBackend.create("MiUnidadP", props)) {
      // Podríamos obviar el nombre de la unidad de persistencia, si sólo hubiera una fábrica.
      jb.transaction(em -> {
         Centro centro = new Centro(11004866L, "IES Castillo de Luna", Centro.Titularidad.PUBLICA);
         em.persist(centro);
      });

      // Este método es capaz de devolver lo que devuelve la función del argumento.
      Centro otro = jb.transactionR(em -> em.get(Centro.class, 11004866L));

      // Podemos obtener en cualquier momento la propia instancia
      JpaBackend jb2 = jpaBackend.get("MiUnidadP");
   }

.. tip:: En caso de que sólo se haya creado una instancia, ni siquiera es necesario usar
   la clave:

   .. code-block:: java

      JpaBackend jb = JpaBackend.get();

.. |DAO| replace:: :abbr:`DAO (Data Access Object)`
.. |CRUD| replace:: :abbr:`CRUD (Create, Read, Update, Delete)`
.. |JDBC| replace:: :abbr:`JDBC (Java DataBase Connectivity)`
.. |ORM| replace:: :abbr:`ORM (Object-Relational Mapping)`
.. |JPA| replace:: :abbr:`JPA (Java Persistence API)`

.. _patrón Singleton: https://es.wikipedia.org/wiki/Singleton
